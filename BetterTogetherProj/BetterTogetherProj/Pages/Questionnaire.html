<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>

    <script src="https://kit.fontawesome.com/a076d05399.js"></script>

    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.3/css/responsive.dataTables.min.css">

    <script src="../Scripts/jquery-3.4.1.min.js"></script>
    <link href="MyStyleSheet.css" rel="stylesheet" />
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="../Scripts/ajaxCalls.js"></script>

    <script src="//cdn.tinymce.com/4/tinymce.min.js"></script>
    <script>tinymce.init({ selector: 'textarea' });</script>

    <!--<script src="https://cdn.anychart.com/releases/8.7.1/js/anychart-base.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.7.1/themes/dark_turquoise.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
    <style type="text/css">

 
    </style>
    <script>

        var QrNumm = 0;
        var AnsNum = 0;
        var q = 0;
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = today.getFullYear();
        today = yyyy + '-' + mm + '-' + dd;
        var statusQR = 1;
        $(document).ready(function () {

            AnsNum = 0;
            Maxqsquantity = 0
            mode = "";

            $("#cancelSaveBTN").on("click", function () { 
                qrId = null;
                $("#editDiv").hide();

                $("#pForm").show();
                $("#filter").show();

                mode = "";
            });
       
            
            $("#newBTNQr").on("click", function () {
               
                $("#openanswer").hide();
                $("#filter").hide();
                ajaxCall("GET", "../api/Questionnaire/GetQNum", "", getQrNum, error);

                ajaxCall("GET", "../api/Questionnaire/dep", "", getSuccessalldep, error);
                AnsNum = 0;
                //$(".statuss").hide();
                q = 0;
               
                $("#question1").html("");
                mode = "new";
                addquestion();

                qrId = null;
               
                $("#pForm").hide();
                $("#editDiv").show();
                $("#addinput").show();
                $("#inserth3").show();
                //$("#EditViewDiv").hide();
                $("#saveBTN").show();

                clearFields();
                $("#editDiv :input").prop("disabled", false); // new mode: enable all controls in the form

            });
;
            $("#ManagerForm").submit(onSubmitFunc);// wire the submit event to a function called f1

            $("#editDiv").hide();

            buttonEvents();
            $(document).on("change", '#publishList', { 'param': 0 }, function (event) {
                getyearbydep(event.data.param);
            });
            let api = "../api/Questionnaire/qr?statusQR=" + statusQR+"&deleteMode=0";
            ajaxCall("GET", api, "", getSuccess, error);
            $("#filter").change(filterQr);

        
        });

        function getQrNum(QrNum) {
            QrNumm = QrNum;
        }

        function getSuccessalldep(alldep) {
            console.log(alldep);
            Alldep = alldep;
            let str = "";
            if (mode == "edit" || mode == "view") {
                document.getElementById("publishList").innerHTML = "";

                for (var i = 0; i < Alldep.length; i++) {
                    if (Alldep[i].DepartmentName == depname)

                        str += "<option value='" + Alldep[i].DepartmentCode + "'>" + Alldep[i].DepartmentName + "</option></br>"
                }
                for (var i = 0; i < Alldep.length; i++) {
                    if (Alldep[i].DepartmentName != depname)

                        str += "<option value='" + Alldep[i].DepartmentCode + "'>" + Alldep[i].DepartmentName + "</option></br>"

                }
            }
            else if (mode == "new") {
                document.getElementById("publishList").innerHTML = "<option value=''>בחירת מחלקה</option>";
                ;
                for (var i = 0; i < Alldep.length; i++) {
                    str += "<option value='" + Alldep[i].DepartmentCode + "'>" + Alldep[i].DepartmentName + "</option></br>"
                }

            }
            document.getElementById("publishList").innerHTML += str;

        }
        function getyearbydep(num) {
            document.getElementById("yearList").innerHTML = "";
            let stryear = "";
            //var years = ["",'א','ב','ג','ד'];
            var years = [0, 1, 2, 3, 4]
            var year = [];
            var nofilter = [];
            if (num == 1) {
                {
                    let depp = depcode;

                    if (depp == 1 || depp == 2 || depp == 3 || depp == 6 || depp == 10 || depp == 15) {
                        for (var j = 0; j < years.length; j++) {
                            if (depyear == years[j]) {
                                year.push(years[j]);
                            }
                        }
                    }
                    else {
                        for (var j = 0; j < years.length - 1; j++) {
                            if (depyear == years[j]) {
                                year.push(years[j]);

                            }
                        }
                    }
                    if (depp == 1 || depp == 2 || depp == 3 || depp == 6 || depp == 10 || depp == 15) {
                        for (var j = 0; j < years.length; j++) {
                            if (depyear != years[j]) {
                                year.push(years[j]);

                            }
                        }
                    }
                    else {
                        for (var j = 0; j < years.length - 1; j++) {
                            if (depyear != years[j]) {
                                year.push(years[j]);

                            }
                        }
                    }
                }
                for (var i = 0; i < year.length; i++) {
                    switch (year[i]) {
                        case 0:
                            stryear += "<option value=0> כלל השנים  </option>";
                            break;
                        case 1:
                            stryear += "<option value=1> א  </option>";
                            break;
                        case 2:
                            stryear += "<option value=2>  ב </option>";
                            break;
                        case 3:
                            stryear += "<option value=3>ג</option>";
                            break;
                        case 4:
                            stryear += "<option value=4>ד</option>";
                            break;

                        default:
                            break;
                    }
                }

            }
            else {

                let depp = $("#publishList").val();
                if (depp == 1 || depp == 2 || depp == 3 || depp == 6 || depp == 10 || depp == 15) {
                    for (var j = 0; j < years.length; j++) {

                        nofilter.push(years[j])
                    }
                }
                else {
                    for (var j = 0; j < years.length - 1; j++) {
                        nofilter.push(years[j])
                    }

                }


                for (var i = 0; i < nofilter.length; i++) {
                    switch (nofilter[i]) {
                        case 0:
                            stryear += "<option value=0> כלל השנים  </option>";
                            break;
                        case 1:
                            stryear += "<option value=1> א  </option>";
                            break;
                        case 2:
                            stryear += "<option value=2>  ב </option>";
                            break;
                        case 3:
                            stryear += "<option value=3>ג</option>";
                            break;
                        case 4:
                            stryear += "<option value=4>ד</option>";
                            break;

                        default:
                            break;
                    }
                }
            }

            document.getElementById("yearList").innerHTML = stryear;

        }


        // wire all the buttons to their functions
        function buttonEvents() {

            $(document).on("click", ".editBtn", function () {
                mode = "edit";
                markSelected(this);
                $("#saveBTN").show();
                //$(".statuss").show();
                $("#editDiv").show();
                $("#addinput").hide();
                $("#inserth3").hide();
                $(".divareaque.form-group.row").hide();
                $("#subQr").prop("disabled", false);
                $("#openanswer").hide();

                populateFields(this.getAttribute('data-QuestionnaireId'));
                if (Qr.DuplicateMode == true) {
                    $("#publishList").prop("disabled", false);
                    $("#yearList").prop("disabled", false);
                    $("#publishDate").prop("disabled", false);
                    $("#EndpublishDate").prop("disabled", false);
                    $("#subQr").prop("disabled", true);

                }
                else {
                    $("#publishList").prop("disabled", true);
                    $("#yearList").prop("disabled", true);
                    $("#publishDate").prop("disabled", false);
                    $("#EndpublishDate").prop("disabled", false);
                    $("#subQr").prop("disabled", false);
                }

                if (Qr.Status == 0 && Qr.EndPublishDate < today) {
                    swal("Attention", "לא ניתן לערוך שאלון שכבר הסתיים!", "error");
                    $("#editDiv").hide();
                }

                if (Qr.DeleteMode == 1) {
                    swal("Attention", "לא ניתן לערוך שאלון שנמחק!", "error");
                    $("#editDiv").hide();
                }
            });

            $(document).on("click", ".viewBtn", function () {
                mode = "view";
                $("#saveBTN").hide();
                markSelected(this);
                $("#pForm").hide();
                //$(".statuss").show();

                $("#editDiv").show();
                $("#addinput").hide();
                $("#inserth3").hide();
                $("#subQr").prop("disabled", true);
                $("#publishList").prop("disabled", true);
                $("#yearList").prop("disabled", true);
                $("#publishDate").prop("disabled", true);
                $("#EndpublishDate").prop("disabled", true);
                //$('#Status').prop("disabled", true)
                $("#openanswer").show();
                $("#filter").hide();

                populateFields(this.getAttribute('data-QuestionnaireId'));

            });

            $(document).on("click", ".duplicateBtn", function () {
                mode = "duplicate";

                markSelected(this);
                $("#editDiv").hide();

                Qr = getQ(this.getAttribute('data-QuestionnaireId'));
               
                let Qrtoduplicate = {

                    QuestionnairePublish: Qr.QuestionnairePublish,
                    EndPublishDate: Qr.EndPublishDate,
                    SubQr: Qr.SubQr,
                    Dep: {
                        DepartmentCode: Qr.Dep.DepartmentCode
                    },
                    NumResponders: 0,
                    Status: Qr.Status,
                    QuestionnaireYear: Qr.QuestionnaireYear,
                    Queslist: Qr.Queslist,
                    QuestionnaireNum: questionnaires[questionnaires["length"] - 1].QuestionnaireNum + 1,
                    DuplicateMode:1
                }
                ajaxCall("POST", "../api/Questionnaire/postqr", JSON.stringify(Qrtoduplicate), insertSuccess, error);
                    return false;
            });

            $(document).on("click", ".deleteBtn", function () {
                mode = "delete";     
                markSelected(this);
                Qr = getQ(this.getAttribute('data-QuestionnaireId'));
                var QrId = this.getAttribute('data-QuestionnaireId');
                swal({ 
                    title: "האם אתה בטוח ?",
                    text: "",
                    icon: "warning",
                    buttons: true,
                    dangerMode: true
                })
                    .then(function (willDelete) {
                        if (willDelete) DeleteQr(QrId);
                        else swal("Not Deleted!");
                    });
            });
            
        }

        function DeleteQr(QrId) {
          
            ajaxCall("PUT", "../api/Questionnaire/updatestatus?QrId=" + QrId  ,"", updateStatusSuccess, error);

        }

        function updateStatusSuccess() {
            ajaxCall("GET", "../api/Questionnaire/qr?statusQR=" + statusQR + "&deleteMode=1" , "", updatestatus, error);
         
        }
        function updatestatus(questionnaireData) {
            tbl.clear();
            questionnaires = questionnaireData;
            redrawTable(tbl, questionnaireData);
            buttonEvents();
            $("#editDiv").hide();
            swal({ title: " !השאלון נמחק בהצלחה", icon: "success" });
            mode = "";
        }

        // mark the selected row
        function markSelected(btn) {
            $("#QTable tr").removeClass("selected"); // remove seleced class from rows that were selected before
            row = (btn.parentNode).parentNode; // button is in TD which is in Row
            row.className = 'selected'; // mark as selected
        }

        function getQuestionType(flag) {
            AnsNum++;
            console.log(q)
            QuestionType = $("#QuestionType" + q).val();
            str = "";

            if (QuestionType == 1 || QuestionType == 2) {
               
                if (flag == 0) {
                    $("#" + q + "Qans").html(str);
                    AnsNum = 1;
                    str += `<input type='text' class='answertext' id='` + q + `answer` + AnsNum + `'required/>
                                                <i type ='button' onclick='getQuestionType(1)' id ='add`+ q + `' class='quesplus fas fa-plus-circle'> </i>`;
                }

                else {

                    str += `<input type='text' class='answertext' id='` + q + `answer` + AnsNum + `'required/>`;
                }

                if (AnsNum > 5) {
                    swal({ icon: 'error', title: 'Sorry', text: " ניתן להכניס עד 6 תשובות לשאלה!" })
                    $(".fa-plus-circle").hide();
                }
            }
            if (QuestionType == 3) {
                $("#" + q + "Qans").hide();
            }
            else
                $("#" + q + "Qans").show();

            $("#" + q + "Qans").append(str);
        }


        function addquestion() {

            AnsNum = 0;
            q++;

            var Questionstring = `<div id="` + q + `">
                                                <div class="questionn">
                                                         <div class="divareaque form-group row">`
            if (mode == "view") {
                Questionstring += `<div class="form-group col-sm-4"><canvas id="myChart` + q + `" class="canvas"></canvas></div>`;

            }
            Questionstring+=`<div class="ansdiv form-group col-sm-2" id="`+ q + `Qans">
                                                           <label for="QuestionText"><span class="red-star">★ </span>תשובות</label>
                                                        </div>

                                                  <div class="form-group col-sm-3">
                                                        <label for="QuestionType`+ q + `"><span class="red-star">★ </span>סוג שאלה</label>
                                                        <select class="form-control Qtype" onchange='getQuestionType(0)' id="QuestionType`+ q + `"required>
                                                            <option value="">בחרי סוג שאלה</option>
                                                            <option value="1">שאלת עם תשובה אחת לבחירה</option>
                                                            <option value="2">שאלה עם מספר תשובות לבחירה</option>
                                                            <option value="3">שאלה פתוחה</option>
                                                        </select>
                                                  </div>
                                                    <div class="form-group col-sm-3" >
                                                        <label for="QuestionText`+ q + `"><span class="red-star">★ </span>תוכן שאלה</label>
                                                        <textarea class="form-control Qtext" id="QuestionText`+ q + `"  required></textarea>
                                                    </div></div></div></div>`
      
                                                         
            $("#question1").append(Questionstring);

        }
        function getanswersbyqu(Qnum) {
           var ansList = [];
            for (var J = 1; J <= 6; J++) {
                Anslist = $("#" + Qnum + "answer" + J).val();
                ansList.push(Anslist);
            }
            //for (var i = AnsNum; i < 6; i++) {
            //    for (var m = 0; m < ansList.length; m++) {
            //        if (ansList[m] == "")
            //            ansList[m].push("");

            //    }
            //}
           
            return ansList;
            console.log(ansList)
        }

        function onSubmitFunc() {

            if (mode == "edit") {

                QrtoUpdate = {
                    QuestionnaireNum: Qr.QuestionnaireNum,
                    SubQr: $("#subQr").val(),
                    QuestionnairePublish: $("#publishDate").val(),
                    EndPublishDate: $("#EndpublishDate").val(),
                    Dep: {
                        DepartmentCode: $("#publishList").val(),
                    },
                    QuestionnaireYear: $("#yearList").val(),
                    Status: Qr.Status

                }

            }

            else if (mode == "new") {
                questionList = [];
                QuestionnairePublish = $("#publishDate").val();
                EndPublishDate = $("#EndpublishDate").val();

                SubQr = $("#subQr").val();
                Depchosen = $("#publishList").val();
                NumResponders = 0;
                QuestionnaireYear = $("#yearList").val();

                for (var i = 1; i <= q; i++) {
                    let Questionn = {
                        Questionnum: i,
                        QuestionText: $(`#QuestionText` + i).val(),
                        QuestionType: $("#QuestionType" + i).val(),
                        Anslist: getanswersbyqu(i),

                    }
                    questionList.push(Questionn);
                }
                console.log(questionList);
                 QrtoSave   = {

                    QuestionnairePublish: QuestionnairePublish,
                    EndPublishDate: EndPublishDate,
                    SubQr: SubQr,
                    Dep: {
                        DepartmentCode: Depchosen
                    },
                    NumResponders: NumResponders,
                    Status: true,
                    QuestionnaireYear: QuestionnaireYear,
                    Queslist: questionList,
                     QuestionnaireNum: QrNumm,
                     DuplicateMode:0
                    
                }

            }


            // add a new Car record to the server
            if (mode == "edit")
                ajaxCall("PUT", "../api/Questionnaire", JSON.stringify(QrtoUpdate), updateSuccess, error);
            else if (mode == "new")
                ajaxCall("POST", "../api/Questionnaire/postqr", JSON.stringify(QrtoSave), insertSuccess, error);

            return false;
        }
        function checkdate(num) {
            if (num == 0) {
                if ($("#publishDate").val() == "") {
                    swal("Attention", "יש למלא תאריך הפצה קודם!", "error");
                    $("#EndpublishDate").val("");
                }
                else if ($("#publishDate").val() > $("#EndpublishDate").val()) {
                    swal("Attention", "תאריך הסיום צריך להיות לאחר תאריך הפצת הפרסום!", "error");
                    $("#EndpublishDate").val("");
                }
                else if ($("#EndpublishDate").val() < today) {
                    swal("Attention", "תאריך הסיום צריך להיות עתידי!", "error");
                    $("#EndpublishDate").val("");
                }
            }
            else if (num == 1) {
                if ($("#publishDate").val() < today) {
                    swal("Attention", "תאריך הפצת השאלון צריך להיות עתידי!", "error");
                    $("#publishDate").val("");

                }
                else {

                }
            }
        }

        // fill the form fields
        function populateFields(qrId) {
            $("#question1").html("");
            Qr = getQ(qrId);
            ajaxCall("GET", "../api/Questionnaire/dep", "", getSuccessalldep, error);

            depname = Qr.Dep.DepartmentName;
            depcode = Qr.Dep.DepartmentCode;
            depyear = Qr.QuestionnaireYear;

            getyearbydep(1);

            var datepub = new Date(Qr.QuestionnairePublish);
            var day = ("0" + datepub.getDate()).slice(-2);
            var month = ("0" + (datepub.getMonth() + 1)).slice(-2);
            var dateQr = datepub.getFullYear() + "-" + (month) + "-" + (day);
            $("#publishDate").val(dateQr);
            var dateEndPub = new Date(Qr.EndPublishDate);
            var day = ("0" + dateEndPub.getDate()).slice(-2);
            var month = ("0" + (dateEndPub.getMonth() + 1)).slice(-2);
            var dateQrfinal = dateEndPub.getFullYear() + "-" + (month) + "-" + (day);
            $("#EndpublishDate").val(dateQrfinal);
           
            $("#subQr").val(Qr.SubQr);
       
            if (mode == "view") {
                $("#" + q + "Qans").html("");
                $(".divareaque").html("");
                q = 0;
                for (var i = 0; i < Qr.Queslist.length; i++) {
                    addquestion();

                    $("#QuestionText" + q).val(Qr.Queslist[i].QuestionText);
                    $("#QuestionType" + q).val(Qr.Queslist[i].QuestionType);
                    $("#QuestionText" + q).prop("disabled", true);
                    $("#QuestionType" + q).prop("disabled", true);
                    if (Qr.Queslist[i].QuestionType == 3) {
                        $("#" + q + "Qans").hide();
                        //$("#myChart" + q).hide();

                    }
                    for (var j = 0; j < Qr.Queslist[i].Anslist.length; j++) {
                        if (Qr.Queslist[i].Anslist[j] != "") {
                            getQuestionType(1);
                            $("#" + q + "answer" + AnsNum).val(Qr.Queslist[i].Anslist[j]);
                            $("#" + q + "answer" + AnsNum).prop("disabled", true);
                        }
                    }
                }

                numQr = Qr.QuestionnaireNum;                 
                let api = "../api/Questionnaire/analyze?numQr=" + numQr + "&depcode=" + depcode + "&depyear=" + depyear;
                ajaxCall("GET", api, "", getSuccessallStudAns, error);                

            }

        }
        function getSuccessallStudAns(studentAns) {
            $("#openanswer").html("");

            sAns = studentAns;    
            R = 1;
            console.log(studentAns);
            let str = "<h3>תשובות הסטודנטים</h3>";
            for (var i = 0; i < Qr.Queslist.length; i++) {
                var arrAns = [0, 0, 0, 0, 0, 0];
                for (var T = 0; T < sAns.length; T++) {
                    if (Qr.Queslist[i].QuestionType == 3 && sAns[T].OpenAnswer != "") {
                        str += "<h4>" + R + ")" + sAns[T].OpenAnswer + "</h4>";
                        R++;
                    }
                    if (Qr.Queslist[i].Questionnum == sAns[T].Questionnum) {
                        for (var j = 0; j < sAns[T].StudAns.length; j++) {
                            if (sAns[T].StudAns[j] == true)
                                for (var m = 0; m < arrAns.length; m++) {
                                    arrAns[j]++;
                                    break;
                                }
                        }
                    }
                    if (Qr.Queslist[i].QuestionType == 3)
                        $("#openanswer").html(str);

                }
                const isAllZero = arrAns.every(item => item === 0)
                k = i + 1;

                if (isAllZero == true) {
                    $("#myChart"+k).hide();
                }
               else if (Qr.Queslist[i].QuestionType != 3 && isAllZero==false ) {
                    var xValues = [Qr.Queslist[i].Anslist[0], Qr.Queslist[i].Anslist[1], Qr.Queslist[i].Anslist[2], Qr.Queslist[i].Anslist[3], Qr.Queslist[i].Anslist[4], Qr.Queslist[i].Anslist[5]];
                    var yValues = [arrAns[0], arrAns[1], arrAns[2], arrAns[3], arrAns[4], arrAns[5]];
                    var barColors = ["red", "green", "blue", "orange", "brown", "pink"];

                    const canvas = document.getElementById('myChart' + k);
                    const ctx = canvas.getContext('2d');
               
                        new Chart(ctx, {
                            type: "bar",
                            data: {
                                labels: xValues,

                                datasets: [{
                                    backgroundColor: barColors,                                   
                                    data: yValues,

                                }

                                ]
                            },
                            options: {
                                legend: { display: false },
                                title: {
                                    display: true,
                                    text: "ניתוח תוצאות שאלה" + " " + Qr.Queslist[i].Questionnum,

                                },

                            },

                        });
                  
                    }

            }
            
        }
       
            

        
        // clear the form fields
        function clearFields() {
            $("#publishDate").val("");
            $("#EndpublishDate").val("");
            $("#subQr").val("");
            $("#publishList :selected").text("בחירת מחלקה");
            $("#yearList :selected").text("בחירת שנה");
            $(".Qtext").val("");
            $(".Qtype").val("");
            $(".answertext").val("");
            $(".quesplus").hide();
            $(".answertext").hide();

        }

        // get a car according to its Id
        function getQ(id) {
            for (i in questionnaires) {
                if (questionnaires[i].QuestionnaireNum == id)
                    return questionnaires[i];
            }
            return null;
        }

        // success callback function after update
        function updateSuccess(questionnaireData) {
            tbl.clear();
            ajaxCall("GET", "../api/Questionnaire/qr?statusQR=" + statusQR + "&deleteMode=0", "", getSuccessupdate, error);

        }

        function getSuccessupdate(questionnaireData) {
            questionnaires = questionnaireData;
            redrawTable(tbl, questionnaireData);
            buttonEvents();
            $("#editDiv").hide();
            swal({ title: " !השאלון עודכן בהצלחה", icon: "success" });
            mode = "";
        }
        // success callback function after update
        function insertSuccess(questionnaireData) {
            console.log(questionnaireData);
            ajaxCall("GET", "../api/Questionnaire/qr?statusQR=" + statusQR + "&deleteMode=0", "", getSuccessinsert, error);

        }
        function getSuccessinsert(questionnaireData) {
            questionnaires = questionnaireData;
            console.log(questionnaireData);
            $("#pForm").show();
            tbl.clear();
            redrawTable(tbl, questionnaireData);
            $("#editDiv").hide();
            if (mode == "new")
                swal("השאלון הוכנס בהצלחה!", "Great Job", "success");
            else if (mode == "duplicate") {
                swal("השאלון שוכפל בהצלחה!", "Great Job", "success");
         
            }
            $("#filter").show();
            mode = "";

        }


        // redraw a datatable with new data
        function redrawTable(tbl, data) {
            tbl.clear();
            for (var i = 0; i < data.length; i++) {
                tbl.row.add(data[i]);
            }
            tbl.draw();
        }
        

        function filterQr() {
            let statusQR = $(this).val();
            let api = "../api/Questionnaire/qr?statusQR=" + statusQR + "&deleteMode=1" ;
            ajaxCall("GET", api, "", getSuccess, error);
        }
        // this function is activated in case of a success
        function getSuccess(questionnaireData) {
      
            console.log(questionnaireData);
            questionnaires = questionnaireData; // keep the cars array in a global variable;
            if ($.fn.dataTable.isDataTable('#QTable')) {//destroy the old table on existence and then create new instance of jQuery DataTable
                $('#QTable').DataTable().clear().destroy();
            }
            try {
                tbl = $('#QTable').DataTable({
                    "oLanguage": {
                        "sLengthMenu": "הצגת _MENU_ שאלונים", "sSearch": "חיפוש: ", "sZeroRecords": "אין תגובות לאירוע זה"
                    },
                    data: questionnaireData,

                    pageLength: 5,
                    columns: [
                        {
                            render: function (data, type, row, meta) {
                                var dataQ = "data-QuestionnaireId='" + row.QuestionnaireNum + "'";

                                editBtn = "<button type='button' class = 'editBtn btn btn-success' " + dataQ + "> <i class='fa fa-edit'></i> </button>";
                                viewBtn = "<button type='button' class = 'viewBtn btn btn-info' " + dataQ + "><i class='fa fa-eye'></i></button>";
                                duplicateBtn = "<button type='button' class = 'duplicateBtn btn btn-success' " + dataQ + "> שכפול שאלון </button>";
                                if ($("#filter").val() == 1)
                                    return editBtn + viewBtn + duplicateBtn;
                                else 
                                    return editBtn+viewBtn ;           

                            }
                        },
                        { data: "QuestionnaireNum" },
                        {
                            data: "QuestionnairePublish",
                            render: function (data, type, row, meta) {
                                shortDateStart = new Date(data);
                                var dd = String(shortDateStart.getDate()).padStart(2, '0');
                                var mm = String(shortDateStart.getMonth() + 1).padStart(2, '0');
                                var yyyy = shortDateStart.getFullYear();

                                shortDateEnd = dd + '-' + mm + '-' + yyyy;
                                return shortDateEnd;
                            }
                        },
                        {
                            data: "EndPublishDate",
                            render: function (data, type, row, meta) {
                                shortDateEnd = new Date(data);
                                var dd = String(shortDateEnd.getDate()).padStart(2, '0');
                                var mm = String(shortDateEnd.getMonth() + 1).padStart(2, '0'); //ינואר זה חודש 0
                                var yyyy = shortDateEnd.getFullYear();

                                shortDateEnd = dd + '-' + mm + '-' + yyyy;
                                return shortDateEnd;
                            }
                        },
                        { data: "SubQr" },
                        { data: "Dep.DepartmentName" },
                        {
                            data: "QuestionnaireYear",
                            render: function (data, type, row, meta) {
                                switch (data) {
                                    case 1:
                                        return 'א';
                                        break;
                                    case 2:
                                        return 'ב';
                                        break;
                                    case 3:
                                        return 'ג';
                                        break;
                                    case 4:
                                        return 'ד';
                                        break;

                                    default:
                                        return 'כלל השנים';

                                }

                            }
                        },
                        { data: "NumResponders" },

                        {

                            render: function (data, type, row, meta) {
                                if ($("#filter").val() == 1) {
                                    deleteBTN = "<button type='button' class = 'deleteBtn btn btn-delete' data-QuestionnaireId='" + row.QuestionnaireNum + "'> <i class='fa fa-trash'></i> </button>";
                                    return deleteBTN;
                                }
                                else
                                    return null;
                    }
                }


                    ],
                });

            }

            catch (err) {
                alert(err);
            }
        }

        // this function is activated in case of a failure
        function error(err) {
            console.log("err");
            swal("Error: " + err);
        }

    </script>
</head>

<body>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <ul class="nav navbar-nav">
                <li><a href="Home.html">דף הבית</a></li>
                <li><a href="AdsTB.html">פרסומים</a></li>
                <li><a href="EventTB.html">אירועים</a></li>
                <li class="active"><a href="Questionnaire.html">שאלונים</a></li>
                <li id="titleNav"><a id="navT">היחידת ליזמות חברתית</a></li>
            </ul>
        </div>
    </nav>
    <h2>שאלוני סטודנטים</h2>

    <button class="newBTN myButton" id="newBTNQr"> יצירת שאלון חדש <span class="glyphicon glyphicon-plus"></span></button>
    
    <div class="form-group col-sm-12">      
        <select class="form-control" id="filter">
            <option value="1">שאלונים פעילים</option>
            <option value="0">שאלונים לא פעילים</option>
        </select>
    </div>
    <form id="pForm">
        <table id="QTable" class="display nowrap" style="width:100%">
            <thead>
                <tr>
                    <th></th>
                    <th>מספר שאלון</th>
                    <th>תאריך הפצה</th>
                    <th>תאריך סיום הפצה</th>
                    <th>נושא השאלון</th>
                    <th>מחלקות</th>
                    <th>שנה</th>
                    <th>מספר משיבים</th>
                    <th></th>

                </tr>
            </thead>
        </table>

    </form>

    <div id="editDiv" class="container">
        <form id="ManagerForm">
            <div class="form-group row">

                <div class="form-group col-sm-4">
                    <label for="EndpublishDate"><span class="red-star">★ </span>תאריך סיום הפצה </label>
                    <input type="date" class="form-control" onchange="checkdate(0)" id="EndpublishDate" placeholder="" required>
                </div>

                <div class="form-group col-sm-4">
                    <label for="publishDate"><span class="red-star">★ </span>תאריך הפצה</label>
                    <input type="date" class="form-control" onchange="checkdate(1)" id="publishDate" placeholder="" required>

                </div>

                <div class="form-group col-sm-4">
                    <label for="subQr"><span class="red-star">★ </span>נושא השאלון</label>
                    <input type="text" class="form-control" id="subQr" placeholder="" required>
                </div>

                <div class="form-group col-sm-4">
                    <label for="yearList" id="yearListText"><span class="red-star">★ </span>שנת תפוצה</label>
                    <select class="form-control" id="yearList" required>
                        <option value="">בחירת שנה</option>
                    </select>
                </div>

                <div class="form-group col-sm-4">
                    <label for="publishList"><span class="red-star">★ </span>רשימת תפוצה</label>
                    <select class="form-control" id="publishList" required>
                    </select>
                </div>
                <!--<div class="form-group col-sm-2">
                    <label for="numResponders"><span class="red-star">★ </span>מספר משיבים</label>
                    <input type="text" class="form-control" id="numResponders" />

                </div>-->
                <!--<div class="statuss form-group col-sm-4">
                    <label for="Status"><span class="red-star">★ </span>סטטוס</label>
                    <input type="checkbox" class="form-control" id="Status" checked />
                </div>-->
                <div class="insertque form-group col-sm-12">
                    <h3 id="inserth3">הכנסת שאלות:</h3>
                </div>
                <div class="questionn1 form-group col-sm-12">
                    <div id="question1"></div>
                </div>
                <div class="addqubutton form-group col-sm-12">
                    <input type="button" value="הוספת שאלה" id="addinput" onclick="addquestion()" />
                </div>
            </div>

            <div id="openanswer"></div>
            <button type="submit" class="btn btn-primary btn-lg" id="saveBTN">שמירה</button>
            <input type="button" class="btn btn-warning btn-lg" id="cancelSaveBTN" value="ביטול" />
        </form>
    </div>

</body>
</html>
